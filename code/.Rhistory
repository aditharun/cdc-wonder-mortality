data <- manuscript_submissions %>% pivot_longer(-type)
data <- data %>% mutate(year = as.numeric(year))
return(data)
}
get_jacc_data <- function(x, file){
manuscript_submissions <- read_excel(path = file, sheet = x) %>% filter(...1 == "Total Manuscripts") %>% select(-1) %>% unname() %>% unlist() %>% na.omit() %>% as.numeric()
print(length(manuscript_submissions)) #should be 13
entries <- c(month.name, "Total")
year <- excel_sheets(file)[x]
data <- data.frame(year = rep(year, length(entries)), name = entries, value = manuscript_submissions)
return(data)
}
#for single total manuscripts only showing All (old harlan file)
#df <- lapply(1:n.sheets, function(x) get_jacc_data(x = x, file = file))
df <- lapply(1:n.sheets, function(x) get_jacc_data_multi(x = x, file = file))
df <- do.call(rbind, df)
df <- df %>% as_tibble() %>% type.convert(as.is = TRUE)
df2 <- df %>% filter(year < 2024)
settype <- "Letters"
df <- df2 %>% filter(type == settype)
yearlabel <- excel_sheets(file) %>% as.numeric() %>% range()
yearlytrend_fig <- df %>% filter(name == "Total") %>% ggplot(aes(x=year, y = value)) + geom_point(size = 3.5, color = "grey30") + geom_line(size = 0.75, color = "grey40") + theme_minimal() + scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) + scale_x_continuous(breaks = seq(yearlabel[1], yearlabel[2], 1)) + theme(panel.border = element_rect(color = "black", fill = "transparent"), panel.grid = element_blank(), axis.ticks = element_line(color = "black"), axis.text = element_text(size = 12), axis.title = element_text(size = 15), axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10)) + xlab("Year") + ylab(paste0(settype, " Submissions to JACC"))
#limits = c(3000, 7000)
month_names <- month.name
month_numeric <- match(month_names, month.name)
month_named_vector <- setNames(month_numeric, month_names)
m.df <- df %>% filter(name != "Total") %>% mutate(name = factor(name, levels = month.name)) %>% arrange(year) %>% mutate(label = paste0(name, year))
m.df$month_num <- month_named_vector[m.df$name] %>% unname()
m.df$label <- factor(m.df$label, levels = m.df$label)
m.df$year <- factor(m.df$year, levels = seq(2002, 2023, 1))
m.df$idx <- 1
monthtrend_fig <- (m.df %>% ggplot(aes(x=label, y=value, color = year, group = idx)) + geom_point(size = 2.75) + geom_line(size = 0.6, color = "grey80", alpha = 0.7) + theme_minimal() + theme(panel.border = element_rect(color = "black", fill = "transparent"), panel.grid = element_blank(), axis.ticks = element_line(color = "black")) + scale_color_manual(values = rep(c("navy", "navy"), 11)) + theme(legend.position = "none") + xlab("Months (2002 - 2023)") + ylab(paste0(settype, " Submissions to JACC")) + theme(axis.text = element_text(size = 14), axis.title = element_text(size = 16)) + scale_y_continuous(breaks = scales::pretty_breaks(n = 10))  + scale_x_discrete(breaks = m.df$label[seq(1, nrow(m.df), by = 12)], labels = unique(m.df$year), expand = c(0.05, 0)) )
yearlytrend_fig
df
get_jacc_data(x =1, file = file)
get_jacc_data_multi(x =1, file = file)
get_jacc_data_multi(x =1, file = file) %>% filter(type == "Letters")
get_jacc_data_multi(x =1, file = file) %>% filter(type == "Letter")
get_jacc_data_multi <- function(x, file){
manuscript_submissions <- read_excel(path = file, sheet = x)
#All Paper, Original Research, Research Letters, (Reviews/Invited pieces)
#Only the first three matters, 2005+ has research letters
manuscript_submissions <- manuscript_submissions[manuscript_submissions$`All papers`=="Total Manuscripts" & !is.na(manuscript_submissions$`All papers`),]
manuscript_submissions <- manuscript_submissions %>% select_if(~ !all(is.na(.)))
manuscript_submissions <- manuscript_submissions %>% select(-1)
colnames(manuscript_submissions) <- c(month.name, "Total")
if (nrow(manuscript_submissions) > 2){
row <- ((read_excel(path = file, sheet = x)  %>% mutate(idx = 1:n()) %>%
filter(`All papers` == "Total Manuscripts") %>% tail(n = 1) %>% pull(idx) ) )
letter_data <- read_excel(path = file, sheet = x)[c(row-1, row), ]
letter_records <- letter_data %>% select(-1) %>% slice(1) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
letter_values <- letter_data %>% select(-1) %>% slice(2) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
if (length(setdiff(c(month.name, "Total"), letter_records)) > 0){
print(setdiff(c(month.name, "Total"), letter_records))
letter_df <- rbind(data.frame(name = setdiff(c(month.name, "Total"), letter_records), value = 0), data.frame(name = letter_records, value = letter_values)) %>% mutate(type = "Letters")
} else{
letter_df <- data.frame(name = letter_records, value = letter_values) %>% mutate(type = "Letters")
}
manuscript_submissions <- manuscript_submissions[1:2,]
manuscript_submissions$type <- c("All", "Original")
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data <- rbind(data, letter_df) %>% as_tibble()
data <- data %>% mutate(year = as.numeric(year))
} else{
manuscript_submissions$type <- c("All", "Original")
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data <- data %>% mutate(year = as.numeric(year))
}
return(data)
}
get_jacc_data_multi(x =1, file = file) %>% filter(type == "Letter")
x <- 5
manuscript_submissions <- read_excel(path = file, sheet = x)
#All Paper, Original Research, Research Letters, (Reviews/Invited pieces)
#Only the first three matters, 2005+ has research letters
manuscript_submissions <- manuscript_submissions[manuscript_submissions$`All papers`=="Total Manuscripts" & !is.na(manuscript_submissions$`All papers`),]
manuscript_submissions <- manuscript_submissions %>% select_if(~ !all(is.na(.)))
manuscript_submissions <- manuscript_submissions %>% select(-1)
colnames(manuscript_submissions) <- c(month.name, "Total")
manuscript_submissions
nrow(manuscript_submissions) > 2
row <- ((read_excel(path = file, sheet = x)  %>% mutate(idx = 1:n()) %>%
filter(`All papers` == "Total Manuscripts") %>% tail(n = 1) %>% pull(idx) ) )
letter_data <- read_excel(path = file, sheet = x)[c(row-1, row), ]
letter_records <- letter_data %>% select(-1) %>% slice(1) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
letter_values <- letter_data %>% select(-1) %>% slice(2) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
length(setdiff(c(month.name, "Total"), letter_records))
print(setdiff(c(month.name, "Total"), letter_records))
letter_df <- rbind(data.frame(name = setdiff(c(month.name, "Total"), letter_records), value = 0), data.frame(name = letter_records, value = letter_values)) %>% mutate(type = "Letters")
letter_df
manuscript_submissions <- manuscript_submissions[1:2,]
manuscript_submissions$type <- c("All", "Original")
manuscript_submissions
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data
rbind(data, letter_df) %>% as_tibble()
rbind(data, letter_df) %>% as_tibble() %>% filter(name == "Letter")
rbind(data, letter_df) %>% as_tibble() %>% filter(name == "Letters")
rbind(data, letter_df) %>% as_tibble() %>% filter(type == "Letters")
get_jacc_data_multi <- function(x, file){
manuscript_submissions <- read_excel(path = file, sheet = x)
#All Paper, Original Research, Research Letters, (Reviews/Invited pieces)
#Only the first three matters, 2005+ has research letters
manuscript_submissions <- manuscript_submissions[manuscript_submissions$`All papers`=="Total Manuscripts" & !is.na(manuscript_submissions$`All papers`),]
manuscript_submissions <- manuscript_submissions %>% select_if(~ !all(is.na(.)))
manuscript_submissions <- manuscript_submissions %>% select(-1)
colnames(manuscript_submissions) <- c(month.name, "Total")
if (nrow(manuscript_submissions) > 2){
row <- ((read_excel(path = file, sheet = x)  %>% mutate(idx = 1:n()) %>%
filter(`All papers` == "Total Manuscripts") %>% tail(n = 1) %>% pull(idx) ) )
letter_data <- read_excel(path = file, sheet = x)[c(row-1, row), ]
letter_records <- letter_data %>% select(-1) %>% slice(1) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
letter_values <- letter_data %>% select(-1) %>% slice(2) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
if (length(setdiff(c(month.name, "Total"), letter_records)) > 0){
print(setdiff(c(month.name, "Total"), letter_records))
letter_df <- rbind(data.frame(name = setdiff(c(month.name, "Total"), letter_records), value = 0), data.frame(name = letter_records, value = letter_values)) %>% mutate(type = "Letters")
} else{
letter_df <- data.frame(name = letter_records, value = letter_values) %>% mutate(type = "Letters")
}
manuscript_submissions <- manuscript_submissions[1:2,]
manuscript_submissions$type <- c("All", "Original")
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data <- rbind(data, letter_df) %>% as_tibble()
data <- data %>% mutate(year = as.numeric(year))
} else{
manuscript_submissions$type <- c("All", "Original")
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data <- data %>% mutate(year = as.numeric(year))
}
return(data)
}
get_jacc_data(x = x, file = file) %>% filter(type == "Letters")
get_jacc_data_multi(x = x, file = file) %>% filter(type == "Letters")
get_jacc_data_multi <- function(x, file){
manuscript_submissions <- read_excel(path = file, sheet = x)
#All Paper, Original Research, Research Letters, (Reviews/Invited pieces)
#Only the first three matters, 2005+ has research letters
manuscript_submissions <- manuscript_submissions[manuscript_submissions$`All papers`=="Total Manuscripts" & !is.na(manuscript_submissions$`All papers`),]
manuscript_submissions <- manuscript_submissions %>% select_if(~ !all(is.na(.)))
manuscript_submissions <- manuscript_submissions %>% select(-1)
colnames(manuscript_submissions) <- c(month.name, "Total")
if (nrow(manuscript_submissions) > 2){
row <- ((read_excel(path = file, sheet = x)  %>% mutate(idx = 1:n()) %>%
filter(`All papers` == "Total Manuscripts") %>% tail(n = 1) %>% pull(idx) ) )
letter_data <- read_excel(path = file, sheet = x)[c(row-1, row), ]
letter_records <- letter_data %>% select(-1) %>% slice(1) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
letter_values <- letter_data %>% select(-1) %>% slice(2) %>% select_if(~ !all(is.na(.))) %>% unname() %>% unlist()
if (length(setdiff(c(month.name, "Total"), letter_records)) > 0){
print(setdiff(c(month.name, "Total"), letter_records))
letter_df <- rbind(data.frame(name = setdiff(c(month.name, "Total"), letter_records), value = 0), data.frame(name = letter_records, value = letter_values)) %>% mutate(type = "Letters")
} else{
letter_df <- data.frame(name = letter_records, value = letter_values) %>% mutate(type = "Letters")
}
manuscript_submissions <- manuscript_submissions[1:2,]
manuscript_submissions$type <- c("All", "Original")
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data <- rbind(data, letter_df) %>% as_tibble()
data <- data %>% mutate(year = as.numeric(year))
} else{
manuscript_submissions$type <- c("All", "Original")
year <- excel_sheets(file)[x]
data <- manuscript_submissions %>% pivot_longer(-type)
data <- data %>% mutate(year = as.numeric(year))
}
return(data)
}
get_jacc_data <- function(x, file){
manuscript_submissions <- read_excel(path = file, sheet = x) %>% filter(...1 == "Total Manuscripts") %>% select(-1) %>% unname() %>% unlist() %>% na.omit() %>% as.numeric()
print(length(manuscript_submissions)) #should be 13
entries <- c(month.name, "Total")
year <- excel_sheets(file)[x]
data <- data.frame(year = rep(year, length(entries)), name = entries, value = manuscript_submissions)
return(data)
}
#for single total manuscripts only showing All (old harlan file)
#df <- lapply(1:n.sheets, function(x) get_jacc_data(x = x, file = file))
df <- lapply(1:n.sheets, function(x) get_jacc_data_multi(x = x, file = file))
df
df <- do.call(rbind, df)
df <- df %>% as_tibble() %>% type.convert(as.is = TRUE)
df2 <- df %>% filter(year < 2024)
df2 %>% filter(type == "Letters")
settype <- "Letters"
df <- df2 %>% filter(type == settype)
yearlabel <- excel_sheets(file) %>% as.numeric() %>% range()
yearlytrend_fig <- df %>% filter(name == "Total") %>% ggplot(aes(x=year, y = value)) + geom_point(size = 3.5, color = "grey30") + geom_line(size = 0.75, color = "grey40") + theme_minimal() + scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) + scale_x_continuous(breaks = seq(yearlabel[1], yearlabel[2], 1)) + theme(panel.border = element_rect(color = "black", fill = "transparent"), panel.grid = element_blank(), axis.ticks = element_line(color = "black"), axis.text = element_text(size = 12), axis.title = element_text(size = 15), axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10)) + xlab("Year") + ylab(paste0(settype, " Submissions to JACC"))
yearlytrend_fig
month_names <- month.name
month_numeric <- match(month_names, month.name)
month_named_vector <- setNames(month_numeric, month_names)
m.df <- df %>% filter(name != "Total") %>% mutate(name = factor(name, levels = month.name)) %>% arrange(year) %>% mutate(label = paste0(name, year))
m.df$month_num <- month_named_vector[m.df$name] %>% unname()
m.df$label <- factor(m.df$label, levels = m.df$label)
m.df$year <- factor(m.df$year, levels = seq(2002, 2023, 1))
m.df$idx <- 1
monthtrend_fig <- (m.df %>% ggplot(aes(x=label, y=value, color = year, group = idx)) + geom_point(size = 2.75) + geom_line(size = 0.6, color = "grey80", alpha = 0.7) + theme_minimal() + theme(panel.border = element_rect(color = "black", fill = "transparent"), panel.grid = element_blank(), axis.ticks = element_line(color = "black")) + scale_color_manual(values = rep(c("navy", "navy"), 11)) + theme(legend.position = "none") + xlab("Months (2002 - 2023)") + ylab(paste0(settype, " Submissions to JACC")) + theme(axis.text = element_text(size = 14), axis.title = element_text(size = 16)) + scale_y_continuous(breaks = scales::pretty_breaks(n = 10))  + scale_x_discrete(breaks = m.df$label[seq(1, nrow(m.df), by = 12)], labels = unique(m.df$year), expand = c(0.05, 0)) )
cowplot::plot_grid(yearlytrend_fig, monthtrend_fig, rel_widths = c(1, 1.3)) %>% ggsave(filename = paste0("~/Downloads/JACC-", settype ,".pdf"), plot = ., units = "in", height = 9, width = 24, device = cairo_pdf)
library(tidyverse)
zenodo <- "~/Downloads/aa-mut-counter/data"
data <- "~/Documents/GitHub/aa-mut-counter/data"
data
list.files(data)
list.files(data, recursive = TRUE)
library(tidyverse)
zenodo <- "~/Downloads/aa-mut-counter/data"
data <- "~/Documents/GitHub/aa-mut-counter/data"
zenodo_files <- list.files(zenodo, recursive = TRUE)
data_files <- list.files(data, recursive = TRUE)
length(zenodo)
length(zenodo_files)
length(data_files)
setdiff(zenodo_files, data_files)
setdiff(data_files, zenodo_files)
file.info(zenodo_files[1])
zenodo_files <- list.files(zenodo, recursive = TRUE, full.names = TRUE)
data_files <- list.files(data, recursive = TRUE, full.names = TRUE)
left_join(data.frame(file = zenodo_files, size_zenodo = z), data.frame(file = data_files, size_orig = d)) %>% as_tibble()
z <- lapply(zenodo_files, function(x) file.info(x)$size) %>% unlist()
d <- lapply(data_files, function(x) file.info(x)$size) %>% unlist()
left_join(data.frame(file = zenodo_files, size_zenodo = z), data.frame(file = data_files, size_orig = d)) %>% as_tibble()
zenodo_files <- list.files(zenodo, recursive = TRUE, full.names = TRUE)
data_files <- list.files(data, recursive = TRUE, full.names = TRUE)
z <- lapply(zenodo_files, function(x) file.info(x)$size) %>% unlist()
d <- lapply(data_files, function(x) file.info(x)$size) %>% unlist()
d
left_join(data.frame(file = list.files(zenodo, recursive = TRUE), size_zenodo = z), data.frame(file = list.files(data, recursive = TRUE), size_orig = d)) %>% as_tibble()
dat <- left_join(data.frame(file = list.files(zenodo, recursive = TRUE), size_zenodo = z), data.frame(file = list.files(data, recursive = TRUE), size_orig = d)) %>% as_tibble()
dat
dat %>% filter(is.na(size_zenodo))
dat %>% filter(is.na(size_orig))
dat %>% mutate(diff = size_zenodo - size_orig)
dat %>% mutate(diff = size_zenodo - size_orig)  %>% filter(diff != 0)
dat %>% mutate(diff = size_zenodo - size_orig) %>% filter(diff != 0)
zenodo <- "~/Downloads/aa-mut-counter/results/all-mut/df_mutfiles.csv" %>% read_csv()
zenodo <- "~/Downloads/aa-mut-counter/results/all-muts/df_mutfiles.csv" %>% read_csv()
orig <- "~/Documents/GitHub/aa-mut-counter/results/all-muts/df_mutfiles.csv" %>% read_csv()
zenodo
zenodo <- "~/Downloads/aa-mut-counter/results/all-muts/df_mutfiles.csv" %>% read_tsv()
orig <- "~/Documents/GitHub/aa-mut-counter/results/all-muts/df_mutfiles.csv" %>% read_tsv()
zenodo
orig
identical(orig, zenodo)
left_join(zenodo %>% select(1,4,5,6,7), orig %>% select(1,4,5,6,7))
orig
left_join(orig, zenodo)
identical(orig, zenodo)
all.equal(orig, zenodo)
identical(as.double(8), as.integer(8), ignore.environment = TRUE)
identical(orig, zenodo, ignore.environment = TRUE)
zenodo <- "~/Downloads/aa-mut-counter/results/all-muts/counts-Cys.txt" %>% read_tsv()
zenodo <- "~/Downloads/aa-mut-counter/results/counts-Cys.txt" %>% read_tsv()
orig <- "~/Documents/GitHub/aa-mut-counter/results/counts-Cys.txt" %>% read_tsv()
zenodo
orig
all.equal(orig, zenodo)
"~/Downloads/test.csv" %>% read_csv()
"~/Downloads/test.csv" %>% read_csv()  %>% group_by(PATIENT_ID)
"~/Downloads/test.csv" %>% read_csv()
"~/Downloads/test.csv" %>% read_csv()  %>% group_by(PATIENT_ID)
"~/Downloads/test.csv" %>% read_csv()  %>% group_by(PATIENT_ID) %>% summarize(n = n())
"~/Downloads/test.csv" %>% read_csv()  %>% group_by(PATIENT_ID) %>% summarize(n = n()) %>% arrange(desc(n))
"~/Downloads/test.csv" %>% read_csv()  %>% group_by(PATIENT_ID) %>% summarize(n = n()) %>% arrange(desc(n))
"~/Downloads/aa-mut-counter/analyses/Cys/mut-rates.rds" %>% readRDS()
z <- "~/Downloads/aa-mut-counter/analyses/Cys/mut-rates.rds" %>% readRDS()
d <- "~/Documents/GitHub/aa-mut-counter/analyses/Cys/mut-rates.rds" %>% readRDS()
z
d
identical(z, d)
DMDEDUC3
z <- "~/Downloads/aa-mut-counter/analyses/Cys/mut-rates.rds" %>% readRDS()
d <- "~/Documents/GitHub/aa-mut-counter/analyses/Cys/mut-rates.rds" %>% readRDS()
z
identical(z,d)
r <- "~/Downloads/mut-rates-github.rds" %>% readRDS()
identical(r, d)
identical(r, z)
z2 <- "~/Downloads/mut-rates-zenodo.rds" %>% readRDS()
identical(z2, z)
identical(z2, d)
z2
zenodo <- "~/Downloads/aa-mut-counter/results/all-muts/df_mutfiles.csv" %>% read_tsv()
zenodo
zenodo
zenodo %>% filter(Variant_Classification == "missense_mutation")
zenodo %>% filter(Variant_Classification == "missense_mutation") %>% filter(CODE == 70537)
zenodo %>% filter(Variant_Classification == "missense_mutation") %>% group_by(Hugo_Symbol)
zenodo %>% filter(Variant_Classification == "missense_mutation") %>% group_by(Hugo_Symbol, HGVSp)
zenodo %>% filter(Variant_Classification == "missense_mutation") %>% group_by(Chromosome) %>% summarize(n = n())
library(tidyverse)
x <- "~/Documents/GitHub/cdc-wonder-mortality/raw-data/master-population.csv" %>% read_csv()
y <- "~/Documents/GitHub/cdc-wonder-mortality/raw-data/mcd/master-population.csv" %>% read_csv()
identical(y,x)
all.equal(x,y)
x
y
setwd("~/Documents/GitHub/cdc-wonder-mortality/code")
input_name <- "cancer"
library(tidyverse)
library(optparse)
data_folder_2021 <- file.path("../raw-data", input_name, "2021")
corrected_data_2021_file <- file.path("../raw-data", input_name, paste0("corrected-2021-data-", input_name, ".csv"))
data_folder_2022 <- file.path("../raw-data", input_name, "2022")
corrected_data_2022_file <- file.path("../raw-data", input_name, paste0("corrected-2022-data-", input_name, ".csv"))
master_pop_file <- file.path("../raw-data", input_name, "master-population.csv")
folder_1999_2020_data <- paste0(file.path("../raw-data", input_name), "/")
suffix_1999_2020 <- paste0("-", input_name, ".txt")
output_file <- file.path("../raw-data", input_name, paste0(input_name, "-deaths.csv"))
readTextFile <- function(filepath){
lines <- readLines(filepath)
index <- which(lines == '"---"')
if (length(index) > 0) {
lines <- lines[1:(index[1] - 1)]
}
list_of_vectors <- lapply(lines, function(x) unlist(strsplit(x, "\t")))
special_encoding <- which(is.na(list_of_vectors))
if (length(special_encoding) > 0){
for (idx in special_encoding){
Encoding(lines[idx]) <- "latin1"
}
list_of_vectors <- lapply(lines, function(x) unlist(strsplit(x, "\t")))
}
df <- do.call(rbind, lapply(list_of_vectors, function(x) as.data.frame(t(x))))
df <- df %>% as_tibble()
df[,1:11] <- lapply(df[,1:11], function(x) gsub('\\"', "", x))
colnames(df) <- df[1,]
df <- df[-1,]
df <- df %>% select(-Notes)
df
}
race6 <- readTextFile("../raw-data/2018-2020-race-6.txt")
race4 <- readTextFile("../raw-data/2018-2020-race-4.txt")
#race 6 to race 5
race6 <- race6 %>% mutate(Race = ifelse(`Single Race 6` %in% c("Asian", "Native Hawaiian or Other Pacific Islander"), "Asian or Pacific Islander", `Single Race 6`))
#supressed 1-9, unreliable 10-19
death_converter <- function(race6, race4){
race6 <- race6 %>% select(`Five-Year Age Groups`, Year, Gender, `Hispanic Origin`, Race, Deaths)
race4 <- race4 %>% select(`Five-Year Age Groups`, Year, Gender,  `Hispanic Origin`, Race, Deaths)
race6 <- race6 %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% type.convert(as.is=TRUE)
race4 <- race4 %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% type.convert(as.is=TRUE)
#take out More than one race in race6
other <- race6 %>% filter(Race == "More than one race")
race6 <- race6 %>% filter(Race != "More than one race")
df <- left_join(race6 %>% group_by(`Five-Year Age Groups`, Year, Gender, `Hispanic Origin`, Race) %>% summarize(deaths_6 = sum(Deaths)) %>% ungroup(Race) ,
race4 %>% group_by(`Five-Year Age Groups`, Year, Gender, `Hispanic Origin`, Race) %>% summarize(deaths_4 = sum(Deaths)) %>% ungroup(Race) )
df <- df %>% mutate(diff = deaths_6 - deaths_4) %>% mutate(diff = ifelse(diff > 0, 0, diff)) #cases where race6 deaths are greater than race4 would mean that we need to remove counts from race6 which does not make sense
df <- df %>% mutate(total = sum(diff)) %>% mutate(diff = abs(diff), total = abs(total)) %>% mutate(frac = ifelse(total > 0, diff / total, 0)) %>% select(1,2,3,4,5,10) %>% group_by(`Five-Year Age Groups`, Gender, `Hispanic Origin`, Race) %>% summarize(mean_frac = mean(frac))
df
}
pop_converter <- function(race6, race4){
race6 <- race6 %>% select(-Deaths)
race4 <- race4 %>% select(-Deaths)
colnames(race4)[colnames(race4) == "Population"] <- "Deaths"
colnames(race6)[colnames(race6) == "Population"] <- "Deaths"
race6$Deaths[race6$Deaths == "Not Applicable"] <- 0
race4$Deaths[race4$Deaths == "Not Applicable"] <- 0
race6 <- race6 %>% select(`Five-Year Age Groups`, Year, Gender, `Hispanic Origin`, Race, Deaths)
race4 <- race4 %>% select(`Five-Year Age Groups`, Year, Gender,  `Hispanic Origin`, Race, Deaths)
race6 <- race6 %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% type.convert(as.is=TRUE)
race4 <- race4 %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% type.convert(as.is=TRUE)
race6 <- race6 %>% mutate(Deaths = ifelse(Deaths == "Unreliable", sample(c(11:19), size = 1), Deaths)) %>% type.convert(as.is=TRUE)
race4 <- race4 %>% mutate(Deaths = ifelse(Deaths == "Unreliable", sample(c(11:19), size = 1), Deaths)) %>% type.convert(as.is=TRUE)
#take out More than one race in race6
other <- race6 %>% filter(Race == "More than one race")
race6 <- race6 %>% filter(Race != "More than one race")
df <- left_join(race6 %>% group_by(`Five-Year Age Groups`, Year, Gender, `Hispanic Origin`, Race) %>% summarize(deaths_6 = sum(Deaths)) %>% ungroup(Race) ,
race4 %>% group_by(`Five-Year Age Groups`, Year, Gender, `Hispanic Origin`, Race) %>% summarize(deaths_4 = sum(Deaths)) %>% ungroup(Race) )
df <- df %>% mutate(diff = deaths_6 - deaths_4) %>% mutate(diff = ifelse(diff > 0, 0, diff)) #cases where race6 deaths are greater than race4 would mean that we need to remove counts from race6 which does not make sense
df <- df %>% mutate(total = sum(diff)) %>% mutate(diff = abs(diff), total = abs(total)) %>% mutate(frac = ifelse(total > 0, diff / total, 0)) %>% select(1,2,3,4,5,10) %>% group_by(`Five-Year Age Groups`, Gender, `Hispanic Origin`, Race) %>% summarize(mean_frac = mean(frac))
df
}
death_conversion_table <- death_converter(race6, race4)
pop_conversion_table <- pop_converter(race6, race4)
### Perform Conversion
#Rates are marked as "not applicable" when the denominator population figure is unavailable, such as "not stated" or unknown age or ethnicity. Deaths of persons with "not stated" or unknown age are not included in the calculation of age-adjusted rates.
newdata <- lapply(list.files(data_folder_2021, full.names = TRUE), function(x) readTextFile(x))
newdata <- do.call(rbind, newdata)
newdata
newdata <- newdata %>% mutate(Race = ifelse(`Single Race 6` %in% c("Asian", "Native Hawaiian or Other Pacific Islander"), "Asian or Pacific Islander", `Single Race 6`))
newdata <- newdata %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% mutate(Population = ifelse(Population == "Suppressed", sample(c(1:9), size = 1), Population)) %>% mutate(Population = ifelse(Population == "Unreliable", sample(c(11:19), size = 1), Population)) %>% filter(Population != "Not Applicable") %>% type.convert(as.is = TRUE) %>% select(-c(`Single Race 6`, `Single Race 6 Code`)) %>% group_by_at(vars(-Deaths, -Population, -`Crude Rate`)) %>% summarize(Deaths = sum(Deaths), Population = sum(Population), `Crude Rate` = Deaths / Population) %>% ungroup()
other <- newdata %>% filter(Race== "More than one race")
list_fin <- list()
for (x in 1:nrow(other)){
row <- other[x,]
deaths <- row$Deaths
pop <- row$Population
a <- death_conversion_table %>% ungroup() %>% filter(`Five-Year Age Groups` == row$`Five-Year Age Groups`, Gender == row$Gender, `Hispanic Origin`==row$`Hispanic Origin`) %>% select(Race, mean_frac) %>% mutate(Deaths = round(mean_frac*deaths)) %>% select(-mean_frac)
b <- pop_conversion_table %>% ungroup() %>% filter(`Five-Year Age Groups` == row$`Five-Year Age Groups`, Gender == row$Gender, `Hispanic Origin`==row$`Hispanic Origin`) %>% select(Race, mean_frac) %>% mutate(Population = round(mean_frac*pop)) %>% select(-mean_frac)
fin <- cbind(left_join(a,b), row %>% select(-c(Deaths, Race, Population, `Crude Rate`)) %>% dplyr::slice(rep(row_number(), each = nrow(a)))) %>% as_tibble()
list_fin[[x]] <- fin
}
distr_counts <- do.call(rbind, list_fin) %>% as_tibble()
data <- newdata %>% filter(Race != "More than one race" )
corrected_data <- rbind(distr_counts %>% mutate(`Crude Rate`=0), data) %>% group_by(`Five-Year Age Groups`, Gender, `Hispanic Origin`, `Underlying Cause of death Code`, Race) %>% summarize(Deaths = sum(Deaths), Population = sum(Population))  %>% ungroup() %>% relocate(Deaths, Population)
newdata <- lapply(list.files(data_folder_2021, full.names = TRUE), function(x) readTextFile(x))
newdata <- do.call(rbind, newdata)
newdata <- newdata %>% mutate(Race = ifelse(`Single Race 6` %in% c("Asian", "Native Hawaiian or Other Pacific Islander"), "Asian or Pacific Islander", `Single Race 6`))
newdata <- newdata %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% mutate(Population = ifelse(Population == "Suppressed", sample(c(1:9), size = 1), Population)) %>% mutate(Population = ifelse(Population == "Unreliable", sample(c(11:19), size = 1), Population)) %>% filter(Population != "Not Applicable") %>% type.convert(as.is = TRUE) %>% select(-c(`Single Race 6`, `Single Race 6 Code`)) %>% group_by_at(vars(-Deaths, -Population, -`Crude Rate`)) %>% summarize(Deaths = sum(Deaths), Population = sum(Population), `Crude Rate` = Deaths / Population) %>% ungroup()
other <- newdata %>% filter(Race== "More than one race")
list_fin <- list()
for (x in 1:nrow(other)){
row <- other[x,]
deaths <- row$Deaths
pop <- row$Population
a <- death_conversion_table %>% ungroup() %>% filter(`Five-Year Age Groups` == row$`Five-Year Age Groups`, Gender == row$Gender, `Hispanic Origin`==row$`Hispanic Origin`) %>% select(Race, mean_frac) %>% mutate(Deaths = round(mean_frac*deaths)) %>% select(-mean_frac)
b <- pop_conversion_table %>% ungroup() %>% filter(`Five-Year Age Groups` == row$`Five-Year Age Groups`, Gender == row$Gender, `Hispanic Origin`==row$`Hispanic Origin`) %>% select(Race, mean_frac) %>% mutate(Population = round(mean_frac*pop)) %>% select(-mean_frac)
fin <- cbind(left_join(a,b), row %>% select(-c(Deaths, Race, Population, `Crude Rate`)) %>% dplyr::slice(rep(row_number(), each = nrow(a)))) %>% as_tibble()
list_fin[[x]] <- fin
}
distr_counts <- do.call(rbind, list_fin) %>% as_tibble()
data <- newdata %>% filter(Race != "More than one race" )
corrected_data <- rbind(distr_counts %>% mutate(`Crude Rate`=0), data) %>% group_by(`Five-Year Age Groups`, Gender, `Hispanic Origin`, Race) %>% summarize(Deaths = sum(Deaths), Population = sum(Population))  %>% ungroup() %>% relocate(Deaths, Population)
write_csv(x = corrected_data, file = corrected_data_2021_file)
newdata <- lapply(list.files(data_folder_2022, full.names = TRUE), function(x) readTextFile(x))
newdata <- do.call(rbind, newdata)
newdata <- newdata %>% mutate(Race = ifelse(`Single Race 6` %in% c("Asian", "Native Hawaiian or Other Pacific Islander"), "Asian or Pacific Islander", `Single Race 6`))
newdata <- newdata %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), size = 1), Deaths)) %>% mutate(Population = ifelse(Population == "Suppressed", sample(c(1:9), size = 1), Population)) %>% mutate(Population = ifelse(Population == "Unreliable", sample(c(11:19), size = 1), Population)) %>% filter(Population != "Not Applicable") %>% type.convert(as.is = TRUE) %>% select(-c(`Single Race 6`, `Single Race 6 Code`)) %>% group_by_at(vars(-Deaths, -Population, -`Crude Rate`)) %>% summarize(Deaths = sum(Deaths), Population = sum(Population), `Crude Rate` = Deaths / Population) %>% ungroup()
other <- newdata %>% filter(Race== "More than one race")
list_fin <- list()
for (x in 1:nrow(other)){
row <- other[x,]
deaths <- row$Deaths
pop <- row$Population
a <- death_conversion_table %>% ungroup() %>% filter(`Five-Year Age Groups` == row$`Five-Year Age Groups`, Gender == row$Gender, `Hispanic Origin`==row$`Hispanic Origin`) %>% select(Race, mean_frac) %>% mutate(Deaths = round(mean_frac*deaths)) %>% select(-mean_frac)
b <- pop_conversion_table %>% ungroup() %>% filter(`Five-Year Age Groups` == row$`Five-Year Age Groups`, Gender == row$Gender, `Hispanic Origin`==row$`Hispanic Origin`) %>% select(Race, mean_frac) %>% mutate(Population = round(mean_frac*pop)) %>% select(-mean_frac)
fin <- cbind(left_join(a,b), row %>% select(-c(Deaths, Race, Population, `Crude Rate`)) %>% dplyr::slice(rep(row_number(), each = nrow(a)))) %>% as_tibble()
list_fin[[x]] <- fin
}
distr_counts <- do.call(rbind, list_fin) %>% as_tibble()
data <- newdata %>% filter(Race != "More than one race" )
corrected_data <- rbind(distr_counts %>% mutate(`Crude Rate`=0), data) %>% group_by(`Five-Year Age Groups`, Gender, `Hispanic Origin`,  Race) %>% summarize(Deaths = sum(Deaths), Population = sum(Population))  %>% ungroup() %>% relocate(Deaths, Population)
write_csv(x = corrected_data, file = corrected_data_2022_file)
new_2021 <- corrected_data_2021_file %>% read_csv() %>% mutate(Year = 2021)
new_2022 <- corrected_data_2022_file %>% read_csv() %>% mutate(Year = 2022)
new <- rbind(new_2021, new_2022) %>% as_tibble()
new
pop_2021_2022 <- new %>% select(Population, `Five-Year Age Groups`, Gender, `Hispanic Origin`, Race, Year) %>% distinct()
pop_2021_2022 <- pop_2021_2022 %>% distinct() %>% as_tibble()
pop_master_df <- "../raw-data/population-1999-2020.txt" %>% readTextFile(.) %>% select(Race, `Hispanic Origin`, `Five-Year Age Groups`, Year, Gender, Population) %>% distinct()
master_pop <- rbind(pop_2021_2022, pop_master_df) %>% as_tibble()
master_pop %>% write_csv(., file = master_pop_file)
#STEP2: edit 2021/2022 to be in the shape of 1999-2020 form which must be in the form of below
new <- new %>% filter(Deaths > 0) %>% select(-Population)
data_1999_2020 <- lapply(paste0(folder_1999_2020_data, seq(1999, 2020, 1), suffix_1999_2020), function(x) readTextFile(x) %>% select(Race, `Hispanic Origin`, `Five-Year Age Groups`, Gender, Deaths) %>% filter(Deaths > 0) %>% mutate(Year = str_sub(basename(x), 1, 4) %>% as.numeric()) )
data_1999_2020
round(845.23, 0)
round((845.23*100), 2)
round((845.23*100), 2)/100
round((845.23/100))*!00
round((845.23/100))*100
ceiling((845.23/100))*100
x <- "~/Documents/GitHub/cdc-wonder-mortality/raw-data/cvd/2021/2021-cvd.txt" %>% readTextFile()
x
x %>% group_by(`Single Race 6`) %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), 1), Deaths))
x %>% group_by(`Single Race 6`) %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), 1), Deaths)) %>% summarize(s = sum(Deaths %>% as.numeric()))
x %>% group_by(`Single Race 6`) %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), 1), Deaths)) %>% summarize(s = sum(Deaths %>% as.numeric())) %>% pull(s)
x %>% group_by(`Single Race 6`) %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), 1), Deaths)) %>% summarize(s = sum(Deaths %>% as.numeric())) %>% pull(s) %>% sum()
x %>% group_by(`Single Race 6`) %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), 1), Deaths)) %>% summarize(s = sum(Deaths %>% as.numeric())) %>% mutate(frac = s / sum(s))
x %>% group_by(`Single Race 6`) %>% mutate(Deaths = ifelse(Deaths == "Suppressed", sample(c(1:9), 1), Deaths)) %>% summarize(s = sum(Deaths %>% as.numeric())) %>% mutate(frac = s / sum(s))
library(tidyverse)
tabledir <- "~/Documents/GitHub/cdc-wonder-output/cvd/tables"
mrr <- file.path(tabledir, "excess_aadr_year.csv") %>% read_csv()
ypll <- file.path(tabledir, "ypll_race_year.csv") %>% read_csv()
ypll
mrr
mrr %>% filter(Year %in% c(1999, 2022))
(1.65 - 1.72)/1.72
mrr %>% filter(Year %in% c(1999, 2015))
mrr %>% filter(Year %in% c(1999, 2015, 2019))
mrr %>% filter(Year %in% c(1999, 2015, 2019, 2020))
(1.8-1.69)/(1.69)
(1.65-1.8)/(1.65)
ypll
ypll %>% filter(Gender == "Female", Race == "Black", Year %in% c(2015, 2020))
ypll %>% filter(Gender == "Female",  Year %in% c(2015, 2020))
8164-4917
ypll <- file.path(tabledir, "ypll_sex_year.csv") %>% read_csv()
ypll
ypll %>% filter(Year %in% c(2015, 2020))
(496942 - 387260) / 387260
mrr
mrr %>% filter(year %in% c(1999, 2022))
mrr %>% filter(Year %in% c(1999, 2022))
(1.62 - 1.5) / 1.62
mrr %>% filter(Year %in% c(2019, 2020))
(1.72 - 1.63) / 1.63
ypll
ypll %>% summarize_all(~mean(.))
ypll %>% summarize_all(~sum(.))
11427437 + 10697935
ypll %>% filter(Year > 2018)
ypll %>% filter(Year %in% c(2004, 2005, 2006))
ypll %>% filter(Year %in% c(1999, 2011))
(386384 - 504567) / 504567
ypll %>% filter(Year %in% c(2011, 2019))
(421611 - 386384) / 386384
ypll %>% filter(Year %in% c(2019, 2020))
(496942 - 421611)/421611
ypll %>% filter(Year %in% c(1999, 2006))
(483032 -  434296) /  434296
ypll %>% filter(Year %in% c(2006, 2011))
(417585 - 483032) / 483032
ypll %>% filter(Year %in% c(2011, 2019))
(507369 - 417585) / 417585
ypll %>% filter(Year %in% c(2020, 2019))
(622823 - 507369) / 507369
c(476143 ,445747 ) %>% mean()
