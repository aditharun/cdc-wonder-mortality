read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, Deaths, Poplation, `Age Adjusted Rate`)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, Deaths, Population, `Age Adjusted Rate`)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess_ageadj_rate = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n())
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% arrange(n)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% as.data.frame()
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n(), black = `Age Adjusted Rate`[Race == "Black"]) %>% filter(n == 1) %>% as.data.frame()
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n(), black = `Age Adjusted Rate`[Race == "White"]) %>% filter(n == 1) %>% as.data.frame()
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess_ageadj_rate = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% summarize(excess_ageadj_rate = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n(), summarize(excess_ageadj_rate = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n(), excess_ageadj_rate = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n())
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% arrange(n)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n < 2)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n < 2)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1)
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n())
read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n())
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`) %>% group_by(Gender, Year, `Cause of death Code`)
ageadj
ageadj %>% summarize(black = `Age Adjusted Rate`[Race == "Black"], white = `Age Adjusted Rate`[Race == "White"])
ageadj
ageadj %>% summarize(n = n()) %>% filter(n == 1)
ageadj %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% mutate(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% mutate(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
missing
ageadj
ageadj %>% ungroup() %>% group_by(Year, `Cause of death Code`) %>% summarize(excess = mean(excess))
ageadj <- ageadj %>% ungroup() %>% group_by(Year, `Cause of death Code`) %>% summarize(excess = mean(excess))
years <- seq(1999, 2021, 1)
ageadj
ageadj %>% magrittr::set_colnames(c("year", "icd", "excess"))
ageadj <- ageadj %>% magrittr::set_colnames(c("year", "icd", "excess"))
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75)
ageadj %>% ggplot(aes(x=year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75)
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
#missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
#ageadj <- rbind(ageadj, missing) %>% as_tibble()
ageadj <- ageadj %>% ungroup() %>% group_by(Year, `Cause of death Code`) %>% summarize(excess = mean(excess))
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess) %>% group_by(icd, Year) %>% summarize(excess = mean(excess))
ageadj
ageadj %>% ggplot(aes(x=year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75)
install.packages("icd")
install.packages("ICD10gm")
library(ICD10gm)
icd_lookup("I15")
ageadj
ageadj %>% ungroup()
read_excel("../data/cms-icd-codes-2023.xlsx")
readxl::read_excel("../data/cms-icd-codes-2023.xlsx")
readxl::read_excel("../data/cms-icd-codes-2023.xlsx") %>% filter(CODE == "I15")
readxl::read_excel("../data/cms-icd-codes-2023.xlsx") %>% filter(CODE == "I150")
readxl::read_excel("../data/cms-icd-codes-2023.xlsx") %>% filter(CODE == "I159")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
#missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
#ageadj <- rbind(ageadj, missing) %>% as_tibble()
ageadj <- ageadj %>% ungroup() %>% group_by(Year, `Cause of death Code`) %>% summarize(excess = mean(excess))
ageadj
ageadj %>% ggplot(aes(x=Year, y=excess, color=`Cause of death Code`, shape=`Cause of death code`)) + geom_line(size = 1) + geom_point(size = 3.75)
ageadj %>% ggplot(aes(x=Year, y=excess, color=`Cause of death Code`, shape=`Cause of death Code`)) + geom_line(size = 1) + geom_point(size = 3.75)
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- rbind(ageadj, missing) %>% as_tibble()
ageadj <- ageadj %>% ungroup() %>% group_by(Year, `Cause of death Code`) %>% summarize(excess = mean(excess))
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess) %>% group_by(icd, Year) %>% summarize(excess = mean(excess))
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75)
ageadj
ageadj %>% group_by(icd) %>% summarize(n = n())
ageadj %>% group_by(icd) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
ageadj %>% group_by(icd) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
library(readxl)
icdfile <- '../data/cms-icd-codes-2023.xlsx'
icd.df <- read_excel(icdfile)
icd.df
icd.df %>% filter(CODE == "I15")
icd.df %>% filter(CODE == "I11")
icd.df %>% filter(CODE == "I11.0")
icd.df %>% filter(CODE == "I11.1")
icd.df %>% filter(CODE == "I111")
icd.df %>% filter(grepl("I10", CODE))
icd.df %>% filter(grepl("I11", CODE))
icd.df %>% filter(grepl("I12", CODE))
icd.df %>% filter(grepl("I13", CODE))
icd.df %>% filter(grepl("I13|I10", CODE))
icd.df %>% filter(grepl("I13(0)|I10", CODE))
ageadj
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
#missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
#ageadj <- rbind(ageadj, missing) %>% as_tibble()
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
ageadj
ageadj <- ageadj %>% group_by(icd) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
#missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
#ageadj <- rbind(ageadj, missing) %>% as_tibble()
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
ageadj
ageadj %>% group_by(icd) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj %>% group_by(icd) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
#missing <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(n = n()) %>% filter(n == 1) %>% mutate(excess = 0) %>% select(-n)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
#ageadj <- rbind(ageadj, missing) %>% as_tibble()
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
#take icd10 codes with complete data
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate")
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5))
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 14))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5))
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5))
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7")
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[icdlength], labels = icdnames)
icdnames
length(icdnames)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(names = "", values = cbb[1:icdlength], labels = icdnames)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", labels = icdnames)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames)
shapechoices <- c(15, 16, 17, 18, 3, 2)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon, "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
pll <- deaths_file %>% read_tsv()
pll
?varImp()
?varImp
?caret::varImp.gbm
library(tidyverse)
library(haven)
library(readxl)
source("preprocess-function.R")
args = commandArgs(trailingOnly=TRUE)
years <- seq(1999, 2021, 1)
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
project <- "HTN"
library(tidyverse)
library(haven)
library(readxl)
source("preprocess-function.R")
args = commandArgs(trailingOnly=TRUE)
years <- seq(1999, 2021, 1)
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
deaths_file
project
args <- "HTN"
library(tidyverse)
library(haven)
library(readxl)
source("preprocess-function.R")
args = commandArgs(trailingOnly=TRUE)
years <- seq(1999, 2021, 1)
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
project
args
args <- "HTN"
years <- seq(1999, 2021, 1)
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
pll
lifeexp_file <- "../data/file_life_expectancy_1999_to_2020.dta"
age_intervals <- c(0, 1, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, Inf)
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
life_exp <- read_dta(lifeexp_file) %>% mutate(Gender=factor(gender)) %>% mutate(Gender=ifelse(Gender=="1", "Female", "Male")) %>% select(-gender) %>% mutate(Gender = as.character(Gender))
life_exp
pll
colnames(pll)[which(colnames(pll)=="Five-Year Ages")] <- "agegroup"
pll <- pll %>% filter(agegroup!="Not Stated") %>% filter(Population!="Not Applicable") %>% select(-ends_with("code")) %>% type.convert(as.is=TRUE)
pll
pll <- pll %>% mutate(age = sub("-.*", "", agegroup))
pll
life_exp
pll <- pll %>% mutate(age = sub("-.*", "", agegroup) %>% as.numeric())
pll
pll %>% filter(is.na(age))
pll %>% filter(is.na(age)) %>% pull(agegroup) %>% unique()
pll <- pll %>% mutate(age = sub("-.*", "", agegroup) %>% as.numeric()) %>% mutate(age = ifelse(is.na(age), 85, age))
pll
life_exp
pll_combined <- pll %>% left_join(life_exp, by=c("age"="age_cat", "Year"="year", "Gender"="Gender"))
pll_combined
pll_combined <- pll_combined %>% mutate(yrs_lost=life_expectancy*((deaths/population)*100000) )
pll_combined <- pll_combined %>% mutate(yrs_lost=life_expectancy*((Deaths/Population)*100000) )
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, age_cat, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, age_cat, age) %>% summarize(excess_yrs_lost = yrs_lost[Race==1] - yrs_lost[Race==3]) %>% ungroup()
pll_combined
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, age_cat, age) %>% summarize(excess_yrs_lost = yrs_lost[Race==1] - yrs_lost[Race==3]) %>% ungroup()
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age) %>% summarize(excess_yrs_lost = yrs_lost[Race==1] - yrs_lost[Race==3]) %>% ungroup()
excess_pll
excess_ypll
excess_pll
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost))
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age) %>% summarize(excess_yrs_lost = yrs_lost[Race==1] - yrs_lost[Race==3]) %>% ungroup()
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age)
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age)  %>% filter(is.na(yrs_lost))
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age)  %>% summarize(n = n())
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age)  %>% summarize(n = n()) %>% filter(n == 1)
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age)  %>% summarize(n = n()) %>% filter(n < 2)
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age) %>% summarize(excess_yrs_lost = yrs_lost[Race=="Black"] - yrs_lost[Race=="White"]) %>% ungroup()
excess_ypll
pll_combined
pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age, Year) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age, Year) %>% summarize(excess_yrs_lost = yrs_lost[Race=="Black"] - yrs_lost[Race=="White"]) %>% ungroup()
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age, Year) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age, Year) %>% summarize(excess_yrs_lost = yrs_lost[Race=="Black"] - yrs_lost[Race=="White"]) %>% ungroup()
excess_ypll
pll
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
pll
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
deaths_file <- file.path(file.path("../data", project), "export_icd_deaths_race_gender_age_year.tsv")
pll <- deaths_file %>% read_tsv()
life_exp <- read_dta(lifeexp_file) %>% mutate(Gender=factor(gender)) %>% mutate(Gender=ifelse(Gender=="1", "Female", "Male")) %>% select(-gender) %>% mutate(Gender = as.character(Gender))
colnames(pll)[which(colnames(pll)=="Five-Year Ages")] <- "agegroup"
colnames(pll)[which(colnames(pll)=="Cause of death Code")] <- "icd"
pll <- pll %>% filter(agegroup!="Not Stated") %>% filter(Population!="Not Applicable") %>% select(-ends_with("code")) %>% type.convert(as.is=TRUE)
pll <- pll %>% mutate(age = sub("-.*", "", agegroup) %>% as.numeric()) %>% mutate(age = ifelse(is.na(age), 85, age))
pll_combined <- pll %>% left_join(life_exp, by=c("age"="age_cat", "Year"="year", "Gender"="Gender"))
pll_combined <- pll_combined %>% mutate(yrs_lost=life_expectancy*((Deaths/Population)*100000) )
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age, Year) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age, Year) %>% summarize(excess_yrs_lost = yrs_lost[Race=="Black"] - yrs_lost[Race=="White"]) %>% ungroup()
excess <- excess_ypll %>% mutate(icd = sub("\\..*", "", icd)) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess_yrs_lost))
#take icd10 codes with complete data
validicd <- excess %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
excess <- excess %>% filter(icd %in% validicd)
excess_ypll
pll_combined
excess_ypll <- pll_combined %>% filter(!is.na(life_expectancy)) %>% group_by(Race, Gender, agegroup, age, Year, icd) %>% summarize(yrs_lost = mean(yrs_lost)) %>% ungroup() %>% group_by(Gender, agegroup, age, Year, icd) %>% summarize(excess_yrs_lost = yrs_lost[Race=="Black"] - yrs_lost[Race=="White"]) %>% ungroup()
excess <- excess_ypll %>% mutate(icd = sub("\\..*", "", icd)) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess_yrs_lost))
#take icd10 codes with complete data
validicd <- excess %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
excess <- excess %>% filter(icd %in% validicd)
excess
excess_ypll
excess_ypll %>% mutate(icd = sub("\\..*", "", icd))
excess_ypll %>% mutate(icd = sub("\\..*", "", icd)) %>% group_by(icd, Year, Gender) %>% summarize(excess = sum(excess_yrs_lost))
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj
ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
excess <- excess_ypll %>% mutate(icd = sub("\\..*", "", icd)) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess_yrs_lost))
excess
validicd <- excess %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
validicd
excess %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
validicd <- excess %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(abs(diff) < 2) %>% pull(icd)
validicd
excess <- excess %>% filter(icd %in% validicd)
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
excess
excess %>% filter(is.na(excess))
excess %>% as.data.frame()
years <- seq(1999, 2020, 1)
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1)
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj_icd_fig <- excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Excess Years of Potential Life Lost") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(excess$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(excess$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
excess %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Excess Years of Potential Life Lost") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(excess$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(excess$excess, na.rm=TRUE)*1.15, 50)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
#take icd10 codes with complete data
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
years
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5))
ageadj
project
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
#take icd10 codes with complete data
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
ageadj
ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
years <- seq(1999, 2021, 1)
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj_icd_fig
args <- "HTN"
years <- seq(1999, 2021, 1)
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
#take icd10 codes with complete data
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj_icd_fig
args <- "IHD"
project <- args[1]
plotdir <- file.path("../plots", project, "icd")
#manually change for each project for now, need to come up with more elegant solution later
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
#take icd10 codes with complete data
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj_icd_fig
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(0, max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5))
ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
geadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years))
ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(abs(diff) > 0)
agead
ageadj %>% filter(icd == "I20")
ageadj %>% filter(icd == "I20")ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
if (project == "HTN"){
icdnames <- c("I10" = "Essential HTN", "I11" = "HTN Heart Disease", "I12" = "HTN CKD", "I13" = "HTN Heart + CKD")
}
if (project == "IHD"){
icdnames <- c("I20" = "UA", "I21" = "MI", "I25" = "Chronic IHD", "I46" = "Cardiac Arrest", "I24" = "Other Acute IHD")
}
icdlength <- length(icdnames)
cbb <- c("#E69F00", "#56B4E9", "#009E73", "maroon", "#D55E00", "#CC79A7")
shapechoices <- c(15, 16, 17, 18, 3, 2)
ageadj_file <- file.path(file.path("../data", project), "export_icd_age_adjusted_deaths_race_gender_year_se.tsv")
ageadj <- read_tsv(ageadj_file) %>% select(`Cause of death Code`, Race, Gender, Year, `Age Adjusted Rate`)
ageadj <- ageadj %>% group_by(Gender, Year, `Cause of death Code`) %>% summarize(excess = `Age Adjusted Rate`[Race == "Black"] - `Age Adjusted Rate`[Race == "White"])
ageadj <- ageadj %>% mutate(icd = sub("\\..*", "", `Cause of death Code`)) %>% select(icd, Year, excess, Gender) %>% group_by(icd, Year, Gender) %>% summarize(excess = mean(excess))
#take icd10 codes with complete data
validicd <- ageadj %>% group_by(icd, Gender) %>% summarize(n = n()) %>% mutate(diff = n - length(years)) %>% filter(diff == 0) %>% pull(icd)
ageadj <- ageadj %>% filter(icd %in% validicd)
sizing_theme <- theme(axis.text = element_text(size=12), axis.title=element_text(size=16), legend.text=element_text(size=12), legend.title=element_text(size=16), plot.title=element_text(size=18, hjust=0.5), strip.background = element_rect(color="black", fill = "transparent"), strip.text = element_text(size = 16))
year_label <- scale_x_continuous(breaks=years, labels= function(x) ifelse(x %% 2 == 1, x, ""))
panel_theme <- theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor=element_blank())
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj_icd_fig
c(min(ageadj$excess), max(ageadj$excess, na.rm=TRUE)*1.15)
c(floor(min(ageadj$excess)), max(ageadj$excess, na.rm=TRUE)*1.15)
ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = c(floor(min(ageadj$excess)), max(ageadj$excess, na.rm=TRUE)*1.15), breaks=seq(floor(min(ageadj$excess)), max(ageadj$excess, na.rm=TRUE)*1.15, 5)) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
if (min(ageadj$excess) < 0){
limits.y <- c(floor(min(ageadj$excess)), max(ageadj$excess, na.rm=TRUE)*1.15)
breaks.y <- c(floor(min(ageadj$excess)), seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5))
} else{
limits.y <- c(0, max(ageadj$excess, na.rm=TRUE)*1.15)
breaks.y <- seq(0, max(ageadj$excess, na.rm=TRUE)*1.15, 5)
}
ageadj_icd_fig <- ageadj %>% ggplot(aes(x=Year, y=excess, color=icd, shape=icd)) + geom_line(size = 1) + geom_point(size = 3.75) + year_label + panel_theme + ylab("Age-Adjusted Excess Death Rate") + facet_wrap(~Gender, nrow = 1) + sizing_theme + scale_y_continuous(limits = limits.y, breaks=breaks.y) + scale_color_manual(name = "", values = cbb[1:icdlength], labels = icdnames) + scale_shape_manual(name = "", values = shapechoices[1:icdlength], labels = icdnames)
ageadj_icd_fig
